---
title: "resprouting_failure"
author: "Eli Bendall & Micheal Bedward"
date: "02/08/2020"
output: word_document
mainfont: Arial
---

```{r setup, include=TRUE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=8, fig.height=6)

library(here)
library(dplyr)
library(ggplot2)
library(mgcv)
library(readxl)
library(stringr)
library(tidyr)
library(bayesplot)
library(brms)
library(tidybayes)
library(RColorBrewer)
library(rstan)
library(splines)
library(forcats)
library(ggthemes)
library(ggpubr)
library(egg)

#These options help Stan run faster:

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

# Make sure the scales package is available (it should be if ggplot is installed)
requireNamespace("scales")

# Default graph theme - white background
theme_set( theme_bw() )

set.seed(42)


# Set to TRUE to force models to be refitted
REFIT_MODELS <- FALSE


# Create a folder for fitted models if one does not already exist
FittedModelsPath <- here("fitted_models")
if (!dir.exists(FittedModelsPath)) {
  dir.create(FittedModelsPath)
}


# Load brms if it is installed (requires Stan software and the rstan package).
# If not installed, HAS_BRMS will be set to FALSE.
HAS_BRMS <- suppressWarnings(
  require("brms", quietly = TRUE)
)


###### Some helper functions #####

# Calculate standard page sizes
pagesize <- function(size = c("A4", "A3", "A2", "A1", "A0"), 
                     orientation = c("portrait", "landscape"),
                     units = c("cm", "mm")) {
  
  size <- match.arg(size)
  orientation <- match.arg(orientation)
  units <- match.arg(units)
  
  alpha <- 1000 * 2^(1/4)
  i <- as.integer(substr(size, 2, 2))
  long <- alpha * 2^(-i/2)
  
  page <- switch(
    orientation,
    portrait = c(width = long / sqrt(2), height = long),
    landscape = c(width = long, height = long / sqrt(2))
  )
  
  page <- round(page)
  if (units == "cm") page <- page / 10
  
  page <- c(as.list(page), units = units)
  class(page) <- "pagesize"
  
  page
}



# Save a graph to a PDF file
gg_pdf <- function(plot, filename, size = pagesize("A4", "landscape", "cm")) {
  
  if (!inherits(size, "pagesize")) stop("The size argument should be a pagesize (list) object")
  
  ggsave(
    filename, 
    plot, 
    width = size$width,
    height = size$height,
    units = size$units)
}


# Calculate highest posterior density interval for a vector of values
hpdi.vec <- function (x, prob = 0.95) {
  n <- length(x)
  if (n <= 1) stop("x must have more than 1 element")
  x <- sort(x)

  gap <- max(1, min(n - 1, round(n * prob)))
  init <- 1:(n - gap)

  inds <- which.min(x[init + gap] - x[init])

  out <- c(lower = x[inds], upper = x[inds + gap])
  out
}


```

## Prepare data 

All field data are in a single Excel workbook.

```{r}

ExcelPathData <- here("data_raw", "Eli_field_data30thMAY.xlsx")

ExcelPathBarkTypes <- here("data_raw", "bark3.xlsx")

```

### Resprouting levels

This look-up table relates field codes for topkill to aggregated classes that will be used for modelling.

```{r}

# Resprout model levels in order of response severity (low to high)
topkillLevels <- data.frame(
  level = c('intact',  'canopy',  'stem',    'tree', 'topkill'),
  
  label = c('success', 'success', 'success', 'fail', 'fail') )

knitr::kable(topkillLevels)

```

### DBH class definitions (to be used for checking)

```{r}

DBH.classes <- data.frame(
  class = 1:4,
  dbh.min = c(0, 2.5, 10, 20)
)

knitr::kable(DBH.classes)

```

### Large trees

```{r}

dat34 <- read_excel(ExcelPathData, sheet = "class3_4", guess_max = 2604) %>%
  
  select(siteid = site_id,
         treeid = tree_id,
         species,
         dbhclass = class,
         dbh:dbh7,
         topkill,
         firescar = fire_scar) %>%
  
  # Add Excel row number (useful to locate records for checking)
  mutate(xlrow = row_number() + 1) %>%
  
  # attach levels/labels
  mutate(topkill = factor(topkill, ordered = TRUE,
                      levels = topkillLevels$level,
                      labels = topkillLevels$label)) %>%

  #filter missing values
  filter(!is.na(topkill)) %>%
  filter(!is.na(firescar))



## merge with bark type
bark <- read_excel(ExcelPathBarkTypes, sheet = "bark_types", guess_max = 100) %>%
  select(species = species,
         barktype = bark_type)

dat34 <- merge(dat34, bark, by="species")
  

```


Check for missing values. It is okay to have NAs in the additional dbh columns: dbh2...dbh7

```{r}
colSums( is.na(dat34) )
```


For multi-stemmed trees, we calculate an equivalent single-stem diameter based on the sum of the areas of the multiple stems.

```{r}

# Function to calculate equivalent single-stem DBH
fn_dbh <- function(...) {
  dbhs <- cbind(...)
  sqrt( rowSums(dbhs^2, na.rm = TRUE) )
}

dat34 <- dat34 %>% 
  mutate(dbhsingle = fn_dbh(dbh, dbh2, dbh3, dbh4, dbh5, dbh6, dbh7)) %>%
  
  ## delete unused DBH columns
  
  select(-(dbh:dbh7))

```


Check for any trees where the single-stem DBH is below the lower threshold for the recorded DBH class. This might indicate a data entry error. For multi-stem trees, the calculated single-stem diameter is always greater than the largest individual stem diameter.

```{r}

small34 <- dat34 %>%
  left_join(DBH.classes, by = c("dbhclass" = "class")) %>%
  filter(dbhsingle < dbh.min) %>%
  select(-dbh.min)

if (nrow(small34) > 0) {
  knitr::kable(small34)
} else {
  cat("No trees with suspect diameters found")
}

```

*TODO* Eli will check the above records. For the moment we will discard them. ### UPDATED - checked by Eli, some records were fixed for large trees, some records for small trees were missing observations

```{r}

if (nrow(small34) > 0) {
  dat34 <- dat34 %>%
    filter( !(xlrow %in% small34$xlrow) )
}

```


## Stumps and logs

```{r}

 
datST <- read_excel(ExcelPathData, sheet = "class5", guess_max = 2500) %>%
  select(siteid = site_id,
         treeid = tree_id,
         species,
         dbhclass = class,
         dbh:dbh5,
         firescar = fire_scar,
         topkill = topkill_alt) %>%
  
  #Add Excel row number (useful to locate records for checking)
  mutate(xlrow = row_number() + 1) %>%
    
  
  # NOTE: Here we only want records for stumpsthat have been deteermined to be topkilled     during the last fire, i.e. 'topkill_alt'. 
  filter(topkill == "topkill") %>%

  
  # Attach labels/levels
  mutate(topkill = factor(topkill, ordered = TRUE,
                      levels = topkillLevels$level,
                      labels = topkillLevels$label)) %>%

  # Filter out missing records, NOTE: for some reason in some places there is an error when   'filter' is used, so here it must be 'dplyr::filter'.
  dplyr::filter(!is.na(topkill)) %>%
  dplyr::filter(!is.na(dbh)) %>%
  dplyr::filter(!is.na(firescar))

 
## merge with barktype

datST <- merge(datST, bark, by="species")


```

## Check for missing values

```{r}

colSums( is.na(datST) )
```
## Calculate single-stem DBH

```{r}

datST <- datST %>% 
  mutate(dbhsingle = fn_dbh(dbh, dbh2, dbh3, dbh4, dbh5)) %>%
         
## NOTE: dbh column has 3 missing values ## Update: Double check this, but should be fixed 
  
  
## delete unused DBH columns

dplyr::select(-(dbh:dbh5))
```


```{r}

smallST <- datST %>%
  left_join(DBH.classes, by = c("dbhclass" = "class")) %>%
  filter(dbhsingle < dbh.min) %>%
  select(-dbh.min)

if (nrow(smallST) > 0) {
  knitr::kable(smallST)
} else {
  cat("No trees with suspect diameters found")
}

```

Eli advises that these zero diameters are to be treated as missing values. We will discard them here:

```{r}

datST <- datST %>%
  filter( !(xlrow %in% smallST$xlrow) )

```


### Combine initial data sets for large and small trees


```{r}
na0 <- function(x) ifelse(is.na(x), 0, x)

DAT.all.trees <- bind_rows(
  mutate(dat34, source = "dat34"),
  mutate(datST, source = "datST")) %>%
  
  # Re-arrange columns a bit
  select(xlrow, treeid, species, starts_with("dbh"), everything()) %>%
  
  
  # Guard against mis-matched species names due to
  # case or spaces
  mutate(species = str_to_title( str_remove_all(species, "\\s+") ) )

```

Check for missing values

```{r}

colSums( is.na(DAT.all.trees) )

```


Check bark types

```{r}

sort( unique( DAT.all.trees$barktype ))

```

There are some records with the character string "NA" (and other discrepencies) - convert these to `NA` missing values. 

```{r}

DAT.all.trees <- DAT.all.trees %>%
  mutate(barktype = ifelse(barktype == "NA", NA_character_, barktype))

DAT.all.trees <- DAT.all.trees %>%
  mutate(barktype = ifelse(barktype == "burnt", NA_character_, barktype))

DAT.all.trees <- DAT.all.trees %>%
  mutate(barktype = ifelse(barktype == "other", NA_character_, barktype))

```


## Species summary

This generates a summary table showing the number of occurrences (sites) for each DBH class by species.

```{r}

species.summary <- DAT.all.trees %>%
  group_by(species, dbhclass) %>%
  summarize(ntrees = n_distinct(treeid)) %>%
  
  mutate(dbhclass = paste0("class", dbhclass)) %>%
  tidyr::spread(dbhclass, ntrees, fill = 0) %>%

  arrange(species)

```


### Species for modelling

Species category "u" means unknown eucalypt. There are some cases in the tree data (both dat34 and dat12) that need to be checked. For the log data we want to include the "u" cases in the modelling data set.

### Update, species entries have been checked, confirm then "u" must be kept in addition to the fake species "E. unkn", which was created for unknown species of charred logs (i.e. bark type = 'burnt').

```{r}

excluded <- c("A.litt", "A.toru", "B.serr", "C.apet", "C.australis", "Other", "other", "A. deal")

species.summary <- species.summary %>%
  mutate(model = !(species %in% excluded) )

```


### Prepare data for modelling

We will exclude the smallest trees (DBH class 1).

```{r}

dat.model <- DAT.all.trees %>%
  
  # Subset to species to model
  left_join(species.summary %>% select(species, model), 
            by = "species") %>%
  
  filter(model) %>%
  select(-model) %>% 
  
  filter(dbhclass > 2)
  
```


Summary table of response frequencies by species:

```{r}

with(dat.model, table(species, topkill))

```


Add site attributes. 

*Note:* this relies on the code in document `import_site_data.Rmd` being run first.

```{r}

load( here("data", "sites.RData") )

dat.model <- dat.model %>%
  left_join(
    DAT.sites %>% select(siteid, vegtype,
                         fireclass, firecount,
                         droughtclass, droughtclass2, spei,
                         easting, northing),
    
    by = "siteid"
  )

```


Define factors for variables to be used in the model and convert "NA" values of barktype to true NAs.

```{r}

dat.model <- dat.model %>%
  
  mutate(dbhclass = factor(dbhclass),
         siteid = factor(siteid),
         barktype = factor(barktype),
         firescar = factor(firescar))

```


## weighting values applied due to mismatched plot sizes between logs and standing trees

```{r}
dat.model <- dat.model %>%
  mutate(
    weights = case_when(
         dbhclass == "3" & source == "dat34" ~ 1,
         dbhclass == "4" & source == "dat34" ~ 1,
         dbhclass == "3" & source == "datST" ~ 0.5,
         dbhclass == "4" & source == "datST" ~ 1))

```

## create interaction term for fire and drought

```{r}
dat.model$firedrought <- interaction(
  dat.model$fireclass, dat.model$droughtclass)
```

## impute missing data for barktype (e.g. some logs did not have their bark type observed). This is unabkle to be done in brms package because: 1) brms doesnt support missing value imputation in ordinal models and 2) a secondary weighting term cannot be applied

```{r}
library(mice)

md.pattern(dat.model)

tempData <- mice(dat.model, m=5, maxit=5)

MI1out <- complete(tempData,1)

summary(MI1out)
```


## Models for DSF observations

```{r}

dat.model.DSF <- MI1out %>%
  filter(vegtype == "dsf")


```


### model code

```{r}

library(future)

plan(multiprocess)

PathBrmsRF1 <- here::here("fitted_models", "model_brmsRF1.RData")

if (REFIT_MODELS || !file.exists(PathBrmsRF1)) {

model.brms.RF1 <- brm(
    topkill|weights(weights) ~ s(dbhsingle, by = firedrought) + firedrought + barktype + firescar + (1 | siteid),
  data = dat.model.DSF,
  family = bernoulli(),
  chains = 4,
  warmup = 1000,
  iter = 5000,
  control = list(adapt_delta = 0.9,
                 max_treedepth = 12),
  future = TRUE)

plan(sequential)
  

save(model.brms.RF1, file = PathBrmsRF1)

} else {
  # Load previously fitted model
  load(PathBrmsRF1)
}



summary(model.brms.RF1)
```

Model summary (similar to that from lme4::glmer). We only use this as a sanity check - not directly for inference.

```{r}

if (HAS_BRMS) {
  summary(model.brms.RF1)
}

```

These values are very similar to those produced by lme4::glmer.


Graphical summaries of fitted parameters (densities and trace plots). Again these are mostly for model checking.

```{r}

if (HAS_BRMS) {
  plot(model.brms.RF1, N=3, ask = FALSE, newpage = FALSE)
}

```



## Models for DSF observations

```{r}

dat.model.WSF <- MI1out %>%
  filter(vegtype == "wsf")


```


### model code

```{r}

library(future)

plan(multiprocess)

PathBrmsRF2 <- here::here("fitted_models", "model_brmsRF2.RData")

if (REFIT_MODELS || !file.exists(PathBrmsRF2)) {

model.brms.RF2 <- brm(
    topkill|weights(weights) ~ s(dbhsingle, by = firedrought) + firedrought + barktype + firescar + (1 | siteid),
  data = dat.model.WSF,
  family = bernoulli(),
  chains = 4,
  warmup = 1000,
  iter = 5000,
  control = list(adapt_delta = 0.9,
                 max_treedepth = 12),
  future = TRUE)

plan(sequential)
  

save(model.brms.RF2, file = PathBrmsRF2)

} else {
  # Load previously fitted model
  load(PathBrmsRF2)
}



summary(model.brms.RF2)
```

Model summary (similar to that from lme4::glmer). We only use this as a sanity check - not directly for inference.

```{r}

if (HAS_BRMS) {
  summary(model.brms.RF2)
}

```

These values are very similar to those produced by lme4::glmer.


Graphical summaries of fitted parameters (densities and trace plots). Again these are mostly for model checking.

```{r}

if (HAS_BRMS) {
  plot(model.brms.RF2, N=3, ask = FALSE, newpage = FALSE)
}

```



### DSF predictions

```{r}

### create all unique combinations of variables (use expand.grid when cont. vars.)
postRF1 <- expand.grid(
  dbhsingle = median(dat.model.DSF$dbhsingle),
  firedrought = levels(dat.model.DSF$firedrought),
  barktype = levels(dat.model.DSF$barktype),
  firescar = levels(dat.model.DSF$firescar)
) %>%
  
### add fitted draws  
  tidybayes::add_fitted_draws(model.brms.RF1, n = 3000, re_formula = NA) %>%
  ungroup() %>%
  
### seperate pred. vars. for graphing and model queries

  tidyr::separate(firedrought, c("fire", "drought"), sep = "\\.", remove = FALSE) %>%
  

    ## Change labels for plotting   
  dplyr::mutate(drought = fct_recode(drought, 
                                     "mild"   = "low", 
                                     "severe" = "high")) %>%


  select(iter = .draw, dbhsingle, fire, barktype, firescar, drought, Probability = .value)

  
```

### POLES

```{r}

effect1 <- postRF1 %>%
  
  
  filter(dbhsingle >= 10 & dbhsingle <= 80 & firescar == "y") %>%

  
  tidyr::unite(drought_fire, drought, fire) %>%
  

  
  tidyr::spread(drought_fire, Probability)
  

effect1.a.sml <- postRF1 %>%
  
  
  filter(dbhsingle >= 10 & dbhsingle <= 11) %>%

  
  tidyr::unite(drought_fire, drought, fire) %>%
  

  
  tidyr::spread(drought_fire, Probability)

effect1.a.avg <- postRF1 %>%
  
  
  filter(dbhsingle >= 25 & dbhsingle <= 26) %>%

  
  tidyr::unite(drought_fire, drought, fire) %>%
  

  
  tidyr::spread(drought_fire, Probability)
  



effect1.b.sml <- postRF1 %>%
  
  
  filter(dbhsingle >= 10 & dbhsingle <= 11) %>%

  tidyr::unite(barktype_firescar, barktype, firescar) %>%

  
  tidyr::spread(barktype_firescar, Probability)

effect1.b.avg <- postRF1 %>%
  
  
  filter(dbhsingle >= 25 & dbhsingle <= 26) %>%

  tidyr::unite(barktype_firescar, barktype, firescar) %>%

  
  tidyr::spread(barktype_firescar, Probability)


  


effect1.c <- postRF1 %>%
  filter(dbhsingle == 12 | dbhsingle == 14 | dbhsingle == 16 | dbhsingle == 34 | dbhsingle == 50 | dbhsingle == 66) %>%
  
  mutate(dbhsingle = case_when(
         dbhsingle == 12 ~ "polelow",
         dbhsingle == 14 ~ "polemid",
         dbhsingle == 16 ~ "polehigh",
         dbhsingle == 34 ~ "maturelow",
         dbhsingle == 50 ~ "maturemid",
         dbhsingle == 66 ~ "maturehigh")) %>%
  
  tidyr::unite(dbhsingle_firescar, dbhsingle, firescar) %>%

  
  tidyr::spread(dbhsingle_firescar, Probability)


```


```{r}

head(effect1)

```


```{r}
## change labels for difference calcs and probability estimates

diffs <- effect1 %>%
  mutate(diff_MD_LF = mild_low,
         diff_MD_HF = mild_high,
         diff_SD_LF = severe_low,
         diff_SD_HF = severe_high)%>%
  
  select(dbhsingle, barktype, starts_with("diff"))

head(diffs)

```

```{r}

## Calculate predicted difference

## diffs drought

diffs1.a.sml <- effect1.a.sml %>%
  
  mutate(diff_lowf = (severe_low -  mild_low),
         diff_highf = (severe_high - mild_high)) %>%
  
  select(barktype, firescar, starts_with("diff"))


diffs1.a.avg <- effect1.a.avg %>%
  
  mutate(diff_lowf = (severe_low -  mild_low),
         diff_highf = (severe_high - mild_high)) %>%
  
  select(barktype, firescar, starts_with("diff"))

## diffs fire

diffs1.a2.sml <- effect1.a.sml %>%
  
  mutate(diff_severe = (severe_high -  severe_low),
         diff_mild = (mild_high - mild_low)) %>%
  
  select(barktype, firescar, starts_with("diff"))


diffs1.a2.avg <- effect1.a.avg %>%
  
  mutate(diff_severe = (severe_high -  severe_low),
         diff_mild = (mild_high - mild_low)) %>%
  
  select(barktype, firescar, starts_with("diff"))


## diffs fire scar

diffs1.b.sml <- effect1.b.sml %>%
  
  mutate(diff_fibrous = (fibrous_y -  fibrous_n),
         diff_hard = (hard_y - hard_n),
         diff_rough = (rough_y -  rough_n),
         diff_smooth = (smooth_y - smooth_n),
         diff_stringy = (stringy_y -  stringy_n)) %>%
  
  select(drought, fire, starts_with("diff"))

diffs1.b.avg <- effect1.b.avg %>%
  
  mutate(diff_fibrous = (fibrous_y -  fibrous_n),
         diff_hard = (hard_y - hard_n),
         diff_rough = (rough_y -  rough_n),
         diff_smooth = (smooth_y - smooth_n),
         diff_stringy = (stringy_y -  stringy_n)) %>%
  
  select(drought, fire, starts_with("diff"))

## diffs bark avg

diffs1.c <- effect1.b.avg %>%
  mutate(diff_fibrous = fibrous_y - ((hard_y + smooth_y + stringy_y + rough_y) / 4),
         diff_hard = hard_y - ((fibrous_y + smooth_y + stringy_y + rough_y) / 4),
         diff_rough = rough_y - ((fibrous_y + smooth_y + stringy_y + hard_y) / 4),
         diff_smooth = smooth_y - ((fibrous_y + hard_y + stringy_y + rough_y) / 4),
         diff_stringy = stringy_y - ((fibrous_y + smooth_y + hard_y + rough_y) / 4)) %>%
  
  select(drought, fire, starts_with("diff"))


## diffs size class

diffs1.d <- effect1.c %>%
  mutate(diff_scarlow = (polelow_y -  maturelow_y),
         diff_noscarlow = (polelow_n - maturelow_n),
         diff_scarmid = (polemid_y -  maturemid_y),
         diff_noscarmid = (polemid_n - maturemid_n),
         diff_scarhigh = (polehigh_y -  maturehigh_y),
         diff_noscarhigh = (polehigh_n - maturehigh_n),) %>%
  
  select(barktype, drought, fire, starts_with("diff"))


```


Graph the differences of each of the three non-reference levels to the reference level:

```{r}
# convert to long format for ggplot
dat.gg <- diffs %>%
  tidyr::gather(var, diff, -barktype, -dbhsingle) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/"))) %>%
  mutate(var = factor(var, levels = c("MD/LF", "MD/HF", "SD/LF", "SD/HF"), 
                           labels = c("MD/LF", "MD/HF", "SD/LF", "SD/HF")))

## barktype, was problem with jagged lines  
x.stats <- dat.gg %>%
  group_by(dbhsingle, var, barktype) %>%
    summarize(mid = median(diff),
                  lwr95 = hpdi.vec(diff, 0.95)[1],
                  upr95 = hpdi.vec(diff, 0.95)[2],
                  lwr50 = hpdi.vec(diff, 0.50)[1],
                  upr50 = hpdi.vec(diff, 0.50)[2])

## barktype, was problem with jagged lines  
x.statsbark <- dat.gg %>%
  group_by(dbhsingle, barktype, firescar) %>%
    summarize(mid = median(diff),
                  lwr95 = hpdi.vec(diff, 0.95)[1],
                  upr95 = hpdi.vec(diff, 0.95)[2],
                  lwr50 = hpdi.vec(diff, 0.50)[1],
                  upr50 = hpdi.vec(diff, 0.50)[2])

# convert to long format for ggplot
dat.gg1.a.sml <- diffs1.a.sml %>%
  tidyr::gather(var, diff, -barktype, -firescar) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/")))


  
x.stats1.a.sml <- dat.gg1.a.sml %>%
  group_by(barktype, firescar, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

# convert to long format for ggplot
dat.gg1.a.avg <- diffs1.a.avg %>%
  tidyr::gather(var, diff, -barktype, -firescar) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/")))


  
x.stats1.a.avg <- dat.gg1.a.avg %>%
  group_by(barktype, firescar, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

# convert to long format for ggplot
dat.gg1.a2.sml <- diffs1.a2.sml %>%
  tidyr::gather(var, diff, -barktype, -firescar) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/")))


  
x.stats1.a2.sml <- dat.gg1.a2.sml %>%
  group_by(barktype, firescar, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

# convert to long format for ggplot
dat.gg1.a2.avg <- diffs1.a2.avg %>%
  tidyr::gather(var, diff, -barktype, -firescar) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/")))


  
x.stats1.a2.avg <- dat.gg1.a2.avg %>%
  group_by(barktype, firescar, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

# convert to long format for ggplot
dat.gg1.b.sml <- diffs1.b.sml %>%
  tidyr::gather(var, diff, -fire, -drought) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/"))) %>%
  mutate(fire = factor(fire, levels = c("low", "high"), 
                             labels = c("low", "high"))) %>%
  mutate(drought = factor(drought, levels = c("mild", "severe"), 
                                   labels = c("MD",   "SD")))

dat.gg1.b.sml$fire <- ordered(dat.gg1.b.sml$fire, levels = c("low", "high"))


  
x.stats1.b.sml <- dat.gg1.b.sml %>%
  group_by(drought, fire, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

dat.gg1.b.avg <- diffs1.b.avg %>%
  tidyr::gather(var, diff, -fire, -drought) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/"))) %>%
  mutate(fire = factor(fire, levels = c("low", "high"), 
                             labels = c("low", "high"))) %>%
  mutate(drought = factor(drought, levels = c("mild", "severe"), 
                                   labels = c("MD",   "SD")))

dat.gg1.b.avg$fire <- ordered(dat.gg1.b.avg$fire, levels = c("low", "high"))


  
x.stats1.b.avg <- dat.gg1.b.avg %>%
  group_by(drought, fire, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

dat.gg1.c <- diffs1.c %>%
  tidyr::gather(var, diff, -fire, -drought) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/"))) %>%
  mutate(fire = factor(fire, levels = c("low", "high"), 
                             labels = c("low", "high"))) %>%
  mutate(drought = factor(drought, levels = c("mild", "severe"), 
                                   labels = c("MD",   "SD")))

dat.gg1.c$fire <- ordered(dat.gg1.c$fire, levels = c("low", "high"))

x.stats1.c <- dat.gg1.c %>%
  group_by(drought, fire, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

# convert to long format for ggplot
dat.gg1.d <- diffs1.d %>%
  tidyr::gather(var, diff, -fire, -drought, -barktype) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/")))
  


  
x.stats1.d <- dat.gg1.d %>%
  group_by(var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])


```


```{r fig.height = 4, fig.width = 6}

library(ggthemes)

rhg_cols2 <- c("grey15", "grey30", "grey53", "grey")
xtext <- c("no scar", "scar", "no scar", "scar", "no scar", "scar", "no scar", "scar")
ytext <- c("Pole-sized")
lines <- c("solid", "dashed", "dotted", "longdash")
My_Theme = theme(
  plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
  axis.title.y = element_text(size = 12, face = "bold"),
  axis.text.y = element_text(size = 10, margin = unit(c(0.1, 0.1, 0.1, -0.2), "cm")),
  axis.text.x = element_text(size = 11, vjust = 0, margin = unit(c(0.15, 0.1, 0.1, 0.1), "cm")),
  axis.title.x = element_text(size = 12, face = "bold", vjust = -1.8),
  strip.text.x = element_text(size = 11),
  strip.text.y = element_text(size = 11),
  strip.text = element_text(size = 11),
  strip.background = element_blank(),
  panel.background = element_blank(),
  strip.placement = "inside",
  axis.ticks.length = unit(-0.07, "cm"),
  axis.ticks = element_line(size = 0.8),
  panel.grid.minor.x = element_blank(),
  panel.grid.major.x = element_blank(),
  panel.grid.minor.y = element_blank(),
  panel.grid.major.y = element_blank(),
  legend.position = c(0.150, 0.70),
  legend.title = element_text(size = 9, hjust = 0.6, face = "bold"),
  legend.text = element_text(size = 9),
  legend.key.width = unit(0.3, "cm"),
  legend.key.height = unit(0.5, "cm"),
  legend.background = element_blank(),
  plot.margin = unit(c(2, 2, 2, 2), "pt"))



DSF.mature.DF <- ggplot(data = dat.gg, aes(x = barktype)) +
  
   My_Theme +
  
     geom_linerange(data = x.stats, aes(ymin = lwr95, ymax = upr95),
               size = 0.5) +
 
   geom_linerange(data = x.stats, aes(ymin = lwr50, ymax = upr50, color = barktype),
               size = 3.5, show.legend = FALSE) +
  
 

  labs(y = "", x = NULL, title = "", fill = "Drought/fire") +

  scale_y_continuous(labels = scales::percent_format(suffix = "", accuracy = 1), limits = c(0, 1)) +
  
  
  scale_fill_brewer(palette = "Dark2") +

facet_wrap(~var)
 
   annotate_figure(DSF.mature.DF, left = text_grob("P mortality (%)", face = "bold", rot = 90, vjust = 0.9))
   
   
      
   
   ggsave("DSF.mature.DF.tst.png") 
  

DSF.mature.DF
```

```{r fig.height = 4, fig.width = 5}

library(ggthemes)

rhg_cols2 <- c("grey15", "grey30", "grey53", "grey")
xtext <- c("no scar", "scar", "no scar", "scar", "no scar", "scar", "no scar", "scar")
ytext <- c("Pole-sized")
lines <- c("solid", "dashed", "dotted", "longdash")
My_Theme = theme(
  plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
  axis.title.y = element_text(size = 12, face = "bold"),
  axis.text.y = element_text(size = 10, margin = unit(c(0.1, 0.1, 0.1, -0.2), "cm")),
  axis.text.x = element_text(size = 11, vjust = 0, margin = unit(c(0.15, 0.1, 0.1, 0.1), "cm")),
  axis.title.x = element_text(size = 12, face = "bold", vjust = -1.8),
  strip.text.x = element_blank(),
  strip.text.y = element_text(size = 11),
  strip.text = element_text(size = 11),
  strip.background = element_blank(),
  panel.background = element_blank(),
  strip.placement = "inside",
  axis.ticks.length = unit(-0.07, "cm"),
  axis.ticks = element_line(size = 0.8),
  panel.grid.minor.x = element_blank(),
  panel.grid.major.x = element_blank(),
  panel.grid.minor.y = element_blank(),
  panel.grid.major.y = element_blank(),
  legend.position = c(0.120, 0.66),
  legend.title = element_text(size = 9, hjust = 0.6, face = "bold"),
  legend.text = element_text(size = 9),
  legend.key.width = unit(0.3, "cm"),
  legend.key.height = unit(0.5, "cm"),
  legend.background = element_blank(),
  plot.margin = unit(c(2, 2, 2, 2), "pt"))


DSF.mature.BK <- ggplot(data = dat.gg, aes(x = dbhsingle)) +
  
   My_Theme +
  
  geom_ribbon(data = x.statsbark, aes(ymin = lwr50, ymax = upr50, fill = barktype), alpha = 0.5) +

  facet_wrap(~firescar) +
 
  labs(y = "", x = NULL, title = "", fill = "Bark type") +
  
  
  scale_x_continuous(limits= c(10, 80)) +
  
  
  scale_y_continuous(labels = scales::percent_format(suffix = "", accuracy = 1), limits = c(0, 1)) +
  
  
  scale_fill_brewer(palette = "Dark2") +
  
    geom_hline(yintercept = 0.15, linetype = "dotted") +
  
    geom_hline(yintercept = 0.02, linetype = "dotted") +

  facet_grid(~var)
 
   annotate_figure(DSF.mature.BK, top = text_grob("Fire scar presence", face = "bold", vjust = 2.5), left = text_grob("P mortality (%)", face = "bold", rot = 90, vjust = 0.9))
   
   ggsave("DSF.mature.BK.png") 
  

DSF.mature.BK
```

Probability of an increase in topkill cats relative to the reference level:

```{r}

means.df.1 <- dat.gg %>%
  mutate(
    dbhsingle = case_when(
         dbhsingle >= 10 & dbhsingle <= 15 ~ "10-15",
         dbhsingle >= 15.1 & dbhsingle <= 25 ~ "15-25",
         dbhsingle >= 25.1 & dbhsingle <= 35 ~ "25-35",
         dbhsingle >= 35.1 & dbhsingle <= 45 ~ "35-45",
         dbhsingle >= 45.1 & dbhsingle <= 55 ~ "45-55",
         dbhsingle >= 55.1 & dbhsingle <= 80 ~ "55-80"))


means.df.2 <- means.df.1 %>% 
  group_by(firescar, dbhsingle, var) %>%
  summarize(prob = mean(diff))




knitr::kable(means.df.2, digits = 3)

```

```{r}
x <- means.df.1 %>%
  group_by(firescar, dbhsingle, var) %>%
  
  summarize(lwr95 = hpdi.vec(diff, 0.95)[1],
            lwr50 = hpdi.vec(diff, 0.5)[1],
            mid = median(diff),
            upr50 = hpdi.vec(diff, 0.5)[2],
            upr95 = hpdi.vec(diff, 0.95)[2])

knitr::kable(x, digits = 3)
```




















































```{r}
means.bk.1 <- dat.gg %>%
  mutate(
    dbhsingle = case_when(
         dbhsingle >= 10 & dbhsingle <= 15 ~ "10-15",
         dbhsingle >= 15.1 & dbhsingle <= 25 ~ "15-25",
         dbhsingle >= 25.1 & dbhsingle <= 35 ~ "25-35",
         dbhsingle >= 35.1 & dbhsingle <= 45 ~ "35-45",
         dbhsingle >= 45.1 & dbhsingle <= 55 ~ "45-55",
         dbhsingle >= 55.1 & dbhsingle <= 80 ~ "55-80"))


means.bk.2 <- means.bk.1 %>%
  group_by(firescar, dbhsingle, barktype) %>%
  summarize(prob = mean(diff))




knitr::kable(means.bk.2, digits = 3)
```





```{r}
x <- means.bk.1 %>%
    group_by(dbhsingle, barktype, firescar) %>%
  
  summarize(lwr95 = hpdi.vec(diff, 0.95)[1],
            lwr50 = hpdi.vec(diff, 0.5)[1],
            mid = median(diff),
            upr50 = hpdi.vec(diff, 0.5)[2],
            upr95 = hpdi.vec(diff, 0.95)[2])

knitr::kable(x, digits = 3)
```
















































### differences


```{r fig.height = 6, fig.width = 7}

rhg_cols2 <- c("grey53", "grey15")

My_Theme = theme(
  plot.title = element_text(size = 12, face = "bold", hjust = 0.95),
  axis.title.y = element_text(size = 12, face = "bold"),
  axis.text.y = element_text(size = 10, margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")),
  axis.text.x = element_blank(),
  axis.title.x = element_blank(),
  strip.text.x = element_text(size = 11),
  strip.text.y = element_text(size = 11),
  strip.text = element_text(size = 11),
  strip.background = element_blank(),
  panel.background = element_blank(),
  strip.placement = "inside",
  axis.ticks.length = unit(-0.07, "cm"),
  axis.ticks = element_line(size = 0.8),
  panel.grid.minor.x = element_blank(),
  panel.grid.major.x = element_blank(),
  panel.grid.minor.y = element_blank(),
  panel.grid.major.y = element_blank(),
  legend.position = "bottom",
  legend.title = element_text(size = 9, hjust = 0.6, face = "bold"),
  legend.text = element_text(size = 8),
  legend.key.width = unit(0.5, "cm"),
  legend.background = element_blank(),
  plot.margin = unit(c(4, 4, 4, 4), "pt"))


DSF.RF.poles.diff.scar <- ggplot(data = dat.gg1.b.avg, aes (x = drought)) +
  
 My_Theme +
  
  geom_linerange(data = x.stats1.b.avg, aes(ymin = lwr95, ymax = upr95, group = fire),
               size = 0.5, position = position_dodge(width = 1)) +
 
  geom_linerange(data = x.stats1.b.avg, aes(ymin = lwr50, ymax = upr50, colour = fire, group = fire),
               size = 3.5, show.legend = FALSE, position = position_dodge(width = 1)) +
  
 
  scale_colour_manual(values = rhg_cols2) +
 
  geom_vline(xintercept = 1.5, linetype = "dotted") +
  
  geom_hline(yintercept = 0, linetype = "dotted") +
  
  labs(x = "") +
 
  
  
  scale_y_continuous(breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1), position = "left") +
  coord_cartesian(ylim=c(0, 1))  +
  
facet_grid(~var)


    DSF.RF.poles.diff.scar

```

```{r fig.height = 6, fig.width = 7}
rhg_cols2 <- c("grey53", "grey15")

My_Theme = theme(
  plot.title = element_text(size = 12, face = "bold", hjust = 0.95),
  axis.title.y = element_text(size = 12, face = "bold"),
  axis.text.y = element_text(size = 10, margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")),
  axis.text.x = element_blank(),
  axis.title.x = element_blank(),
  strip.text.x = element_blank(),
  strip.text.y = element_text(size = 11),
  strip.text = element_text(size = 11),
  strip.background = element_blank(),
  panel.background = element_blank(),
  strip.placement = "inside",
  axis.ticks.length = unit(-0.07, "cm"),
  axis.ticks = element_line(size = 0.8),
  panel.grid.minor.x = element_blank(),
  panel.grid.major.x = element_blank(),
  panel.grid.minor.y = element_blank(),
  panel.grid.major.y = element_blank(),
  legend.position = "bottom",
  legend.title = element_text(size = 9, hjust = 0.6, face = "bold"),
  legend.text = element_text(size = 8),
  legend.key.width = unit(0.5, "cm"),
  legend.background = element_blank(),
  plot.margin = unit(c(4, 4, 4, 4), "pt"))


DSF.RF.poles.diff.bark <- ggplot(data = dat.gg1.c, aes (x = drought)) +
  
 My_Theme +
  
  geom_linerange(data = x.stats1.c, aes(ymin = lwr95, ymax = upr95, group = fire),
               size = 0.5, position = position_dodge(width = 1)) +
 
  geom_linerange(data = x.stats1.c, aes(ymin = lwr50, ymax = upr50, colour = fire, group = fire),
               size = 3.5, show.legend = FALSE, position = position_dodge(width = 1)) +
  
 
  scale_colour_manual(values = rhg_cols2) +
 
  geom_vline(xintercept = 1.5, linetype = "dotted") +
  
  geom_hline(yintercept = 0, linetype = "dotted") +
 
  labs(color = "Fire frequency") +
  
  scale_y_continuous(breaks = c(-0.4, -0.2, 0, 0.2, 0.4), position = "left") +
  coord_cartesian(ylim=c(-0.4, 0.4))  +

  
 facet_grid(~var)

    
DSF.RF.poles.diff.bark
```


diff drought sml
```{r}
means <- dat.gg1.a.sml %>%
  group_by(firescar, var, barktype) %>%
  summarize(prob = mean(diff))


knitr::kable(means, digits = 3)
```
diff drought avg
```{r}
means <- dat.gg1.a.avg %>%
  group_by(firescar, var, barktype) %>%
  summarize(prob = mean(diff))


knitr::kable(means, digits = 3)
```


diff fire sml
```{r}
means <- dat.gg1.a2.sml %>%
  group_by(firescar, var, barktype) %>%
  summarize(prob = mean(diff))


knitr::kable(means, digits = 3)
```

diff fire avg
```{r}
means <- dat.gg1.a2.avg %>%
  group_by(firescar, var, barktype) %>%
  summarize(prob = mean(diff))


knitr::kable(means, digits = 3)
```

diff fire scar sml

```{r}

means <- dat.gg1.b.sml %>%
  group_by(drought, fire, var) %>%
  summarize(prob = mean(diff))

knitr::kable(means, digits = 3)

```

diff fire scar sml

```{r}

means <- dat.gg1.b.avg %>%
  group_by(drought, fire, var) %>%
  summarize(prob = mean(diff))

knitr::kable(means, digits = 3)

```


diff bark avg
```{r}
means <- dat.gg1.c %>%
  group_by(drought, fire, var) %>%
  summarize(prob = mean(diff))

knitr::kable(means, digits = 3)
```

diff size class

```{r}
means <- dat.gg1.d %>%
  group_by(var) %>%
  summarize(prob = mean(diff))

knitr::kable(means, digits = 3)
```



### WSF predictions

```{r}

### create all unique combinations of variables (use expand.grid when cont. vars.)
postRF2 <- expand.grid(
  dbhsingle = seq(10, 255, 2),
  firedrought = levels(dat.model.WSF$firedrought),
  barktype = levels(dat.model.WSF$barktype),
  firescar = levels(dat.model.WSF$firescar)
) %>%
  
### add fitted draws  
  tidybayes::add_fitted_draws(model.brms.RF2, n = 3000, re_formula = NA) %>%
  ungroup() %>%
  
### seperate pred. vars. for graphing and model queries

  tidyr::separate(firedrought, c("fire", "drought"), sep = "\\.", remove = FALSE) %>%
  

    ## Change labels for plotting   
  dplyr::mutate(drought = fct_recode(drought, 
                                     "mild"   = "low", 
                                     "severe" = "high")) %>%


  select(iter = .draw, dbhsingle, fire, barktype, firescar, drought, Probability = .value)

  
```




### POLES

```{r}


effect3 <- postRF2 %>%
  
  
  filter(dbhsingle >= 10 & dbhsingle <= 80) %>%

  
  tidyr::unite(drought_fire, drought, fire) %>%
  
  tidyr::spread(drought_fire, Probability)

effect3.a.sml <- postRF2 %>%
  
  
  filter(dbhsingle >= 10 & dbhsingle <= 11) %>%

  
  tidyr::unite(drought_fire, drought, fire) %>%
  
  tidyr::spread(drought_fire, Probability)

effect3.a.avg <- postRF2 %>%
  
  
  filter(dbhsingle >= 40 & dbhsingle <= 41) %>%

  
  tidyr::unite(drought_fire, drought, fire) %>%
  
  tidyr::spread(drought_fire, Probability)


effect3.b.sml <- postRF2 %>%
  
  
  filter(dbhsingle >= 10 & dbhsingle <= 11) %>%

  
  tidyr::unite(barktype_firescar, barktype, firescar) %>%

  
  tidyr::spread(barktype_firescar, Probability)

effect3.b.avg <- postRF2 %>%
  
  
  filter(dbhsingle >= 40 & dbhsingle <= 41) %>%

  
  tidyr::unite(barktype_firescar, barktype, firescar) %>%

  
  tidyr::spread(barktype_firescar, Probability)

## diffs bark avg

diffs3.c <- effect3.b.avg %>%
  mutate(diff_fibrous = fibrous_y - ((hard_y + smooth_y + stringy_y + rough_y) / 4),
         diff_hard = hard_y - ((fibrous_y + smooth_y + stringy_y + rough_y) / 4),
         diff_rough = rough_y - ((fibrous_y + smooth_y + stringy_y + hard_y) / 4),
         diff_smooth = smooth_y - ((fibrous_y + hard_y + stringy_y + rough_y) / 4),
         diff_stringy = stringy_y - ((fibrous_y + smooth_y + hard_y + rough_y) / 4)) %>%
  
  select(drought, fire, starts_with("diff"))



effect3.c <- postRF2 %>%
  filter(dbhsingle == 12 | dbhsingle == 14 | dbhsingle == 16 | dbhsingle == 44 | dbhsingle == 70 | dbhsingle == 96) %>%
  
  mutate(dbhsingle = case_when(
         dbhsingle == 12 ~ "polelow",
         dbhsingle == 14 ~ "polemid",
         dbhsingle == 16 ~ "polehigh",
         dbhsingle == 44 ~ "maturelow",
         dbhsingle == 70 ~ "maturemid",
         dbhsingle == 96 ~ "maturehigh")) %>%
  
  tidyr::unite(dbhsingle_firescar, dbhsingle, firescar) %>%

  
  tidyr::spread(dbhsingle_firescar, Probability)




```


```{r}

head(effect3)

```


```{r}

 # change labels for difference and probability calculations

diffs3 <- effect3 %>%
 
  mutate(diff_MD_LF = mild_low,
         diff_MD_HF = mild_high,
         diff_SD_LF = severe_low,
         diff_SD_HF = severe_high) %>%
  
  select(barktype, dbhsingle, firescar, starts_with("diff"))

head(diffs3)

```


```{r}
## Calculate predicted difference

## diffs drought
diffs3.a.sml <- effect3.a.sml %>%
  
  mutate(diff_lowf = (severe_low -  mild_low),
         diff_highf = (severe_high - mild_high)) %>%
  
  select(barktype, firescar, starts_with("diff"))


diffs3.a.avg <- effect3.a.avg %>%
  
  mutate(diff_lowf = (severe_low -  mild_low),
         diff_highf = (severe_high - mild_high)) %>%
  
  select(barktype, firescar, starts_with("diff"))


## diffs fire
diffs3.a2.sml <- effect3.a.sml %>%
  
  mutate(diff_severe = (severe_high -  severe_low),
         diff_mild = (mild_high - mild_low)) %>%
  
  select(barktype, firescar, starts_with("diff"))

diffs3.a2.avg <- effect3.a.avg %>%
  
  mutate(diff_severe = (severe_high -  severe_low),
         diff_mild = (mild_high - mild_low)) %>%
  
  select(barktype, firescar, starts_with("diff"))


## diffs fire scar
diffs3.b.sml <- effect3.b.sml %>%
  
  mutate(diff_fibrous = (fibrous_y -  fibrous_n),
         diff_hard = (hard_y - hard_n),
         diff_rough = (rough_y -  rough_n),
         diff_smooth = (smooth_y - smooth_n),
         diff_stringy = (stringy_y -  stringy_n)) %>%
  
  select(drought, fire, starts_with("diff"))

diffs3.b.avg <- effect3.b.avg %>%
  
  mutate(diff_fibrous = (fibrous_y -  fibrous_n),
         diff_hard = (hard_y - hard_n),
         diff_rough = (rough_y -  rough_n),
         diff_smooth = (smooth_y - smooth_n),
         diff_stringy = (stringy_y -  stringy_n)) %>%
  
  select(drought, fire, starts_with("diff"))


## diffs bark avg
diffs3.c <- effect3.b.avg %>%
  mutate(diff_fibrous = fibrous_y - ((hard_y + smooth_y + stringy_y + rough_y) / 4),
         diff_hard = hard_y - ((fibrous_y + smooth_y + stringy_y + rough_y) / 4),
         diff_rough = rough_y - ((fibrous_y + smooth_y + stringy_y + hard_y) / 4),
         diff_smooth = smooth_y - ((fibrous_y + hard_y + stringy_y + rough_y) / 4),
         diff_stringy = stringy_y - ((fibrous_y + smooth_y + hard_y + rough_y) / 4)) %>%
  
  select(drought, fire, starts_with("diff"))

## diffs size class

diffs3.d <- effect3.c %>%
  mutate(diff_scarlow = (polelow_y -  maturelow_y),
         diff_noscarlow = (polelow_n - maturelow_n),
         diff_scarmid = (polemid_y -  maturemid_y),
         diff_noscarmid = (polemid_n - maturemid_n),
         diff_scarhigh = (polehigh_y -  maturehigh_y),
         diff_noscarhigh = (polehigh_n - maturehigh_n),) %>%
  
  select(barktype, drought, fire, starts_with("diff"))


```

## prepare data for ggplot

```{r}
# convert to long format for ggplot
dat.gg3 <- diffs3 %>%
  tidyr::gather(var, diff, -barktype, -firescar, -dbhsingle) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/"))) %>%
  mutate(var = factor(var, levels = c("MD/LF", "MD/HF", "SD/LF", "SD/HF"), 
                           labels = c("MD/LF", "MD/HF", "SD/LF", "SD/HF")))

  
x.stats3 <- dat.gg3 %>%
  group_by(dbhsingle, var, firescar) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

x.stats3bark <- dat.gg3 %>%
  group_by(barktype, firescar, dbhsingle) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])


# convert to long format for ggplot
dat.gg3.a.sml <- diffs3.a.sml %>%
  tidyr::gather(var, diff, -barktype, -firescar) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/")))


x.stats3.a.sml <- dat.gg3.a.sml %>%
  group_by(barktype, firescar, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

dat.gg3.a.avg <- diffs3.a.avg %>%
  tidyr::gather(var, diff, -barktype, -firescar) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/")))


x.stats3.a.avg <- dat.gg3.a.avg %>%
  group_by(barktype, firescar, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

# convert to long format for ggplot
dat.gg3.a2.sml <- diffs3.a2.sml %>%
  tidyr::gather(var, diff, -barktype, -firescar) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/")))


  
x.stats3.a2.sml <- dat.gg3.a2.sml %>%
  group_by(barktype, firescar, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

dat.gg3.a2.avg <- diffs3.a2.avg %>%
  tidyr::gather(var, diff, -barktype, -firescar) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/")))


  
x.stats3.a2.avg <- dat.gg3.a2.avg %>%
  group_by(barktype, firescar, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

# convert to long format for ggplot
dat.gg3.b.sml <- diffs3.b.sml %>%
  tidyr::gather(var, diff, -fire, -drought) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/"))) %>%
  mutate(fire = factor(fire, levels = c("low", "high"), 
                             labels = c("low", "high"))) %>%
  mutate(drought = factor(drought, levels = c("mild", "severe"), 
                                   labels = c("MD",   "SD")))

dat.gg3.b.sml$fire <- ordered(dat.gg3.b.sml$fire, levels = c("low", "high"))


  
x.stats3.b.sml <- dat.gg3.b.sml %>%
  group_by(drought, fire, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

dat.gg3.b.avg <- diffs3.b.avg %>%
  tidyr::gather(var, diff, -fire, -drought) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/"))) %>%
  mutate(fire = factor(fire, levels = c("low", "high"), 
                             labels = c("low", "high"))) %>%
  mutate(drought = factor(drought, levels = c("mild", "severe"), 
                                   labels = c("MD",   "SD")))

dat.gg3.b.avg$fire <- ordered(dat.gg3.b.avg$fire, levels = c("low", "high"))


  
x.stats3.b.avg <- dat.gg3.b.avg %>%
  group_by(drought, fire, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

dat.gg3.c <- diffs3.c %>%
  tidyr::gather(var, diff, -fire, -drought) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/"))) %>%
  mutate(fire = factor(fire, levels = c("low", "high"), 
                             labels = c("low", "high"))) %>%
  mutate(drought = factor(drought, levels = c("mild", "severe"), 
                                   labels = c("MD",   "SD")))

dat.gg3.c$fire <- ordered(dat.gg3.c$fire, levels = c("low", "high"))

x.stats3.c <- dat.gg3.c %>%
  group_by(drought, fire, var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])

# convert to long format for ggplot
dat.gg3.d <- diffs3.d %>%
  tidyr::gather(var, diff, -fire, -drought, -barktype) %>%
  mutate(var = factor(str_replace(var, "diff_", ""))) %>%
  mutate(var = factor(str_replace(var, "_", "/")))
  


  
x.stats3.d <- dat.gg3.d %>%
  group_by(var) %>%
    summarize(mid = median(diff),
            lwr95 = hpdi.vec(diff, 0.95)[1],
            upr95 = hpdi.vec(diff, 0.95)[2],
            lwr50 = hpdi.vec(diff, 0.50)[1],
            upr50 = hpdi.vec(diff, 0.50)[2])


```


```{r fig.height = 4, fig.width = 5}


library(ggthemes)

rhg_cols2 <- c("grey15", "grey30", "grey53", "grey")
xtext <- c("no scar", "scar", "no scar", "scar", "no scar", "scar", "no scar", "scar")
ytext <- c("Pole-sized")
lines <- c("solid", "dashed", "dotted", "longdash")
My_Theme = theme(
  plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
  axis.title.y = element_text(size = 12, face = "bold"),
  axis.text.y = element_text(size = 10, margin = unit(c(0.1, 0.1, 0.1, -0.2), "cm")),
  axis.text.x = element_text(size = 11, vjust = 0, margin = unit(c(0.15, 0.1, 0.1, 0.1), "cm")),
  axis.title.x = element_text(size = 12, face = "bold", vjust = -1.8),
  strip.text.x = element_text(size = 11),
  strip.text.y = element_text(size = 11),
  strip.text = element_text(size = 11),
  strip.background = element_blank(),
  panel.background = element_blank(),
  strip.placement = "inside",
  axis.ticks.length = unit(-0.07, "cm"),
  axis.ticks = element_line(size = 0.8),
  panel.grid.minor.x = element_blank(),
  panel.grid.major.x = element_blank(),
  panel.grid.minor.y = element_blank(),
  panel.grid.major.y = element_blank(),
  legend.position = c(0.150, 0.70),
  legend.title = element_text(size = 9, hjust = 0.6, face = "bold"),
  legend.text = element_text(size = 9),
  legend.key.width = unit(0.3, "cm"),
  legend.key.height = unit(0.5, "cm"),
  legend.background = element_blank(),
  plot.margin = unit(c(2, 2, 2, 2), "pt"))





WSF.mature.DF <- ggplot(data = dat.gg, aes(x = dbhsingle)) +
  
   My_Theme +
  
  geom_ribbon(data = x.stats3, aes(ymin = lwr50, ymax = upr50, fill = var), alpha = 0.5) +

  facet_wrap(~firescar) +
 
  labs(y = "", x = NULL, title = "", fill = "Drought/fire") +
  
  scale_x_continuous(limits= c(10, 80)) +
  
  scale_y_continuous(labels = scales::percent_format(suffix = "", accuracy = 1), limits = c(0, 1)) +
  
  
  scale_fill_brewer(palette = "Set1") +
  
      geom_hline(yintercept = 0.15, linetype = "dotted") +
  
    geom_hline(yintercept = 0.02, linetype = "dotted") +
  
  facet_grid(~firescar)
 
   ggsave("WSF.mature.DF.png") 
  

WSF.mature.DF
```


```{r fig.height = 4, fig.width = 5}

library(ggthemes)

rhg_cols2 <- c("grey15", "grey30", "grey53", "grey")
xtext <- c("no scar", "scar", "no scar", "scar", "no scar", "scar", "no scar", "scar")
ytext <- c("Pole-sized")
lines <- c("solid", "dashed", "dotted", "longdash")
My_Theme = theme(
  plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
  axis.title.y = element_text(size = 12, face = "bold"),
  axis.text.y = element_text(size = 10, margin = unit(c(0.1, 0.1, 0.1, -0.2), "cm")),
  axis.text.x = element_text(size = 11, vjust = 0, margin = unit(c(0.15, 0.1, 0.1, 0.1), "cm")),
  axis.title.x = element_text(size = 12, face = "bold", vjust = -1.8),
  strip.text.x = element_blank(),
  strip.text.y = element_text(size = 11),
  strip.text = element_text(size = 11),
  strip.background = element_blank(),
  panel.background = element_blank(),
  strip.placement = "inside",
  axis.ticks.length = unit(-0.07, "cm"),
  axis.ticks = element_line(size = 0.8),
  panel.grid.minor.x = element_blank(),
  panel.grid.major.x = element_blank(),
  panel.grid.minor.y = element_blank(),
  panel.grid.major.y = element_blank(),
  legend.position = c(0.120, 0.66),
  legend.title = element_text(size = 9, hjust = 0.6, face = "bold"),
  legend.text = element_text(size = 9),
  legend.key.width = unit(0.3, "cm"),
  legend.key.height = unit(0.5, "cm"),
  legend.background = element_blank(),
  plot.margin = unit(c(2, 2, 2, 2), "pt"))





WSF.mature.BK <- ggplot(data = dat.gg3, aes(x = dbhsingle)) +
  
   My_Theme +
  
  geom_ribbon(data = x.stats3bark, aes(ymin = lwr50, ymax = upr50, fill = barktype), alpha = 0.5) +

  facet_wrap(~firescar) +
 

  labs(y = "", x = NULL, title = "", fill = "Bark type") +
  
  
  scale_x_continuous(limits= c(10, 80)) +
  
  
  scale_y_continuous(labels = scales::percent_format(suffix = "", accuracy = 1), limits = c(0, 1)) +
  
  
  scale_fill_brewer(palette = "Dark2") +
  
      geom_hline(yintercept = 0.15, linetype = "dotted") +
  
    geom_hline(yintercept = 0.02, linetype = "dotted") +
  

  facet_grid(~firescar)
 

   ggsave("WSF.mature.BK.png") 
  

WSF.mature.BK
```

Probability estimates

```{r}

means.df.3 <- dat.gg3 %>%
  mutate(
    dbhsingle = case_when(
         dbhsingle >= 10 & dbhsingle <= 15 ~ "10-15",
         dbhsingle >= 15.1 & dbhsingle <= 25 ~ "15-25",
         dbhsingle >= 25.1 & dbhsingle <= 35 ~ "25-35",
         dbhsingle >= 35.1 & dbhsingle <= 45 ~ "35-45",
         dbhsingle >= 45.1 & dbhsingle <= 55 ~ "45-55",
         dbhsingle >= 55.1 & dbhsingle <= 80 ~ "55-80"))


means.df.4 <- means.df.3 %>%
  group_by(firescar, dbhsingle, var) %>%
  summarize(prob = mean(diff))




knitr::kable(means.df.4, digits = 3)

```








```{r}
x <- means.df.3 %>%
  group_by(firescar, dbhsingle, var) %>%
  
  summarize(lwr95 = hpdi.vec(diff, 0.95)[1],
            lwr50 = hpdi.vec(diff, 0.5)[1],
            mid = median(diff),
            upr50 = hpdi.vec(diff, 0.5)[2],
            upr95 = hpdi.vec(diff, 0.95)[2])

knitr::kable(x, digits = 3)
```






























```{r}

means.bk.3 <- dat.gg3 %>%
  mutate(
    dbhsingle = case_when(
         dbhsingle >= 10 & dbhsingle <= 15 ~ "10-15",
         dbhsingle >= 15.1 & dbhsingle <= 25 ~ "15-25",
         dbhsingle >= 25.1 & dbhsingle <= 35 ~ "25-35",
         dbhsingle >= 35.1 & dbhsingle <= 45 ~ "35-45",
         dbhsingle >= 45.1 & dbhsingle <= 55 ~ "45-55",
         dbhsingle >= 55.1 & dbhsingle <= 80 ~ "55-80"))


means.bk.4 <- means.bk.3 %>%
  group_by(firescar, dbhsingle, barktype) %>%
  summarize(prob = mean(diff))




knitr::kable(means.bk.4, digits = 3)
```






```{r}
x <- means.bk.3 %>%
    group_by(dbhsingle, barktype, firescar) %>%
  
  summarize(lwr95 = hpdi.vec(diff, 0.95)[1],
            lwr50 = hpdi.vec(diff, 0.5)[1],
            mid = median(diff),
            upr50 = hpdi.vec(diff, 0.5)[2],
            upr95 = hpdi.vec(diff, 0.95)[2])

knitr::kable(x, digits = 3)
```











### differences


```{r fig.height = 6, fig.width = 7}

rhg_cols2 <- c("grey53", "grey15")

My_Theme = theme(
  plot.title = element_text(size = 12, face = "bold", hjust = 0.95),
  axis.title.y = element_text(size = 12, face = "bold"),
  axis.text.y = element_text(size = 10, margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")),
  axis.text.x = element_blank(),
  axis.title.x = element_blank(),
  strip.text.x = element_text(size = 11),
  strip.text.y = element_text(size = 11),
  strip.text = element_text(size = 11),
  strip.background = element_blank(),
  panel.background = element_blank(),
  strip.placement = "inside",
  axis.ticks.length = unit(-0.07, "cm"),
  axis.ticks = element_line(size = 0.8),
  panel.grid.minor.x = element_blank(),
  panel.grid.major.x = element_blank(),
  panel.grid.minor.y = element_blank(),
  panel.grid.major.y = element_blank(),
  legend.position = "bottom",
  legend.title = element_text(size = 9, hjust = 0.6, face = "bold"),
  legend.text = element_text(size = 8),
  legend.key.width = unit(0.5, "cm"),
  legend.background = element_blank(),
  plot.margin = unit(c(4, 4, 4, 4), "pt"))


WSF.RF.poles.diff.scar <- ggplot(data = dat.gg3.b.avg, aes (x = drought)) +
  
 My_Theme +
  
  geom_linerange(data = x.stats3.b.avg, aes(ymin = lwr95, ymax = upr95, group = fire),
               size = 0.5, position = position_dodge(width = 1)) +
 
  geom_linerange(data = x.stats3.b.avg, aes(ymin = lwr50, ymax = upr50, colour = fire, group = fire),
               size = 3.5, show.legend = FALSE, position = position_dodge(width = 1)) +
  
 
  scale_colour_manual(values = rhg_cols2) +
 
  geom_vline(xintercept = 1.5, linetype = "dotted") +
  
  geom_hline(yintercept = 0, linetype = "dotted") +
  
  labs(x = "") +
 
  
  
  scale_y_continuous(breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1), position = "left") +
  coord_cartesian(ylim=c(0, 1))  +
  
facet_grid(~var)

#  DSF.RP.poles.diff.scar <- annotate_figure(DSF.RP.poles.diff.scar, top = text_grob("Bark type", face = "bold", vjust = 0.3), left = text_grob("\u0394 P membership due to fire scar (%)", face = "bold", rot = 90, hjust = 0.4, vjust = 0.3))
  
    WSF.RF.poles.diff.scar

```

```{r fig.height = 6, fig.width = 7}
rhg_cols2 <- c("grey53", "grey15")

My_Theme = theme(
  plot.title = element_text(size = 12, face = "bold", hjust = 0.95),
  axis.title.y = element_text(size = 12, face = "bold"),
  axis.text.y = element_text(size = 10, margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")),
  axis.text.x = element_blank(),
  axis.title.x = element_blank(),
  strip.text.x = element_blank(),
  strip.text.y = element_text(size = 11),
  strip.text = element_text(size = 11),
  strip.background = element_blank(),
  panel.background = element_blank(),
  strip.placement = "inside",
  axis.ticks.length = unit(-0.07, "cm"),
  axis.ticks = element_line(size = 0.8),
  panel.grid.minor.x = element_blank(),
  panel.grid.major.x = element_blank(),
  panel.grid.minor.y = element_blank(),
  panel.grid.major.y = element_blank(),
  legend.position = "bottom",
  legend.title = element_text(size = 9, hjust = 0.6, face = "bold"),
  legend.text = element_text(size = 8),
  legend.key.width = unit(0.5, "cm"),
  legend.background = element_blank(),
  plot.margin = unit(c(4, 4, 4, 4), "pt"))


WSF.RF.poles.diff.bark <- ggplot(data = dat.gg3.c, aes (x = drought)) +
  
 My_Theme +
  
  geom_linerange(data = x.stats3.c, aes(ymin = lwr95, ymax = upr95, group = fire),
               size = 0.5, position = position_dodge(width = 1)) +
 
  geom_linerange(data = x.stats3.c, aes(ymin = lwr50, ymax = upr50, colour = fire, group = fire),
               size = 3.5, show.legend = FALSE, position = position_dodge(width = 1)) +
  
 
  scale_colour_manual(values = rhg_cols2) +
 
  geom_vline(xintercept = 1.5, linetype = "dotted") +
  
  geom_hline(yintercept = 0, linetype = "dotted") +
 
  labs(color = "Fire frequency") +
  
  scale_y_continuous(breaks = c(-0.4, -0.2, 0, 0.2, 0.4), position = "left") +
  coord_cartesian(ylim=c(-0.4, 0.4))  +

  
 facet_grid(~var)

    
WSF.RF.poles.diff.bark
```

diff drought sml
```{r}
means <- dat.gg3.a.sml %>%
  group_by(firescar, var, barktype) %>%
  summarize(prob = mean(diff))

knitr::kable(means, digits = 3)
```


diff drought avg
```{r}
means <- dat.gg3.a.avg %>%
  group_by(firescar, var, barktype) %>%
  summarize(prob = mean(diff))

knitr::kable(means, digits = 3)
```


diff fire sml
```{r}
means <- dat.gg3.a2.sml %>%
  group_by(firescar, var, barktype) %>%
  summarize(prob = mean(diff))

knitr::kable(means, digits = 3)
```

diff fire avg
```{r}
means <- dat.gg3.a2.avg %>%
  group_by(firescar, var, barktype) %>%
  summarize(prob = mean(diff))

knitr::kable(means, digits = 3)
```


diff fire scar sml
```{r}

means <- dat.gg3.b.sml %>%
  group_by(drought, fire, var) %>%
  summarize(prob = mean(diff))

knitr::kable(means, digits = 3)

```

diff fire scar avg
```{r}

means <- dat.gg3.b.avg %>%
  group_by(drought, fire, var) %>%
  summarize(prob = mean(diff))

knitr::kable(means, digits = 3)

```

diff bark avg
```{r}
means <- dat.gg3.c %>%
  group_by(drought, fire, var) %>%
  summarize(prob = mean(diff))

knitr::kable(means, digits = 3)
```

diff size class
```{r}
means <- dat.gg3.d %>%
  group_by(var) %>%
  summarize(prob = mean(diff))

knitr::kable(means, digits = 3)
```

